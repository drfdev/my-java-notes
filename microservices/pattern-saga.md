### Паттерн Saga

Сага представляет собой набор локальных транзакций.
Каждая локальная транзакция обновляет базу данных и публикует сообщение или событие,
инициируя следующую локальную транзакцию в саге.
Если транзакция завершилась неудачей, например, из-за нарушения бизнес правил,
тогда сага запускает компенсирующие транзакции, которые откатывают изменения,
сделанные предшествующими локальными транзакциями.


Существует два способа координации саг:
- Хореография (Choreography)  
  каждая транзакция публикует события, которые запускают транзакции в других сервисах.
- Оркестровка (Orchestration)  
  оркестратор говорит участникам, какие транзакции должны быть запущены.


Пример: **сага основанная на хореографии (Choreography-based saga)**

![alt text](https://microservices.io/i/sagas/Create_Order_Saga.png)

Приложение будет содержать следующие шаги:
1) `Order Service` получает запрос `POST /orders` и создает заказ `Order` с состоянии `PENDING`
2) Этот шаг отправляет сообщение `Order Created`
3) Обработчик событий `Customer Service` делает попытку зарезервировать деньги
4) Это, в свою очередь, отправляет сообщение
5) Обработчик событий `Order Service` подтверждает или отказывает заказ


Пример: **сага основанная на оркестрации (Orchestration-based saga)**

![alt text](https://microservices.io/i/sagas/Create_Order_Saga_Orchestration.png)

Приложение будет содержать следующие шаги:
1) `Order Service` получает запрос `POST /orders` и создает `Create Order` saga-оркестратор
2) Saga-оркестратор создает заказ `Order` в состоянии `PENDING`
3) Отправляется команда `Reserve Credit` в сервис `Customer Service`
4) `Customer Service` делает попытку зарезервировать деньги
5) В ответ посылается сообщение с результатом
6) Saga-оркестратор принимает решение: подтвердить или отказать заказ `Order`


**Преимущества**:
* Позволяет приложению поддерживать согласованность данных между сервисами
  без использования распределенных транзакций.


**Недостатки**:
* Модель программирования становится более сложной. Например, разработчики
  должны проектировать компенсирующие транзакции, которые отменяют изменения, сделанные ранее в саге.




---

Info:
- https://microservices.io/patterns/data/saga.html
- https://habr.com/ru/articles/427705/

